worker_processes 1;
error_log /dev/stdout info;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    access_log /dev/stdout;
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    sendfile on;

    # Include additional server configurations (e.g., for testing ingress)
    include /etc/nginx/hass-jarvis-*.conf;

    client_body_temp_path /tmp/client_body;
    proxy_temp_path /tmp/proxy;
    fastcgi_temp_path /tmp/fastcgi;
    uwsgi_temp_path /tmp/uwsgi;
    scgi_temp_path /tmp/scgi;

    # Mastra Studio UI Server - no JWT authentication
    # Listens on port 4113 (for Home Assistant ingress) and 4111 (for direct access)
    # Proxies to internal Mastra Studio on port 8113
    # Home Assistant ingress provides authentication
    server {
        server_name 0.0.0.0;
        listen 4113;
        listen 4111;

        # Mastra Studio UI - Home Assistant sets X-Ingress-Path header
        location / {
            # Check if we have an ingress path header
            set $ingress_path $http_x_ingress_path;
            
            # If ingress path is set and the request starts with it, strip it
            # This allows both direct access (no prefix) and ingress access (with prefix)
            if ($ingress_path != "") {
                rewrite ^$ingress_path/(.*) /$1 break;
                rewrite ^$ingress_path$ / break;
            }
            
            proxy_pass http://localhost:8113;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Port $server_port;

            # Rewrite HTML responses to add ingress prefix to absolute paths
            # This ensures assets and links work through the ingress
            sub_filter_once off;
            sub_filter_types text/html;
            
            # Inject base tag to help with relative path resolution
            sub_filter '<head>' '<head><base href="$http_x_ingress_path/">';
            
            # Rewrite absolute paths in HTML to include the ingress prefix
            sub_filter 'src="/assets/' 'src="$http_x_ingress_path/assets/';
            sub_filter 'href="/assets/' 'href="$http_x_ingress_path/assets/';
            sub_filter 'src="/mastra.svg"' 'src="$http_x_ingress_path/mastra.svg"';
            sub_filter 'href="/mastra.svg"' 'href="$http_x_ingress_path/mastra.svg"';

            # WebSocket support
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Origin $scheme://$host;
            proxy_cache off;
            proxy_buffering off;
        }
    }

    # MCP Server - JWT authentication required
    # Exposed on port 4112, proxies to internal port 8112
    server {
        server_name 0.0.0.0;
        listen 4112;

        # MCP Server endpoint
        location / {
            # JWT Authentication - include if key file was generated
            include /etc/nginx/jwt-auth.conf;
            
            proxy_pass http://localhost:8112;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Port $server_port;

            # WebSocket support for MCP
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Origin $scheme://$host;
            proxy_cache off;
            proxy_buffering off;
        }
    }
}
