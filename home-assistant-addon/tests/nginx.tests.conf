# Test nginx configuration for Home Assistant ingress simulation
# This file gets included by the base nginx.conf inside the http block
# Simulates how Home Assistant proxies addon traffic through ingress paths
#
# IMPORTANT: This configuration simulates ONLY the ingress proxy layer.
# In production, Home Assistant serves the addon web UI with proper base path handling.
# The Mastra SPA does not support configurable base paths, so assets will fail when
# accessed through the ingress path in testing. This is expected and acceptable because:
# 1. We're testing that the ingress path itself works (proxy, headers, websockets)
# 2. In production, Home Assistant handles the full request lifecycle differently
# 3. The core functionality (API endpoints, WebSockets) will work through ingress

server {
    server_name 0.0.0.0;
    listen 5000;

    # Home Assistant ingress path simulation
    # In production, Home Assistant creates paths like /api/hassio_ingress/{token}/
    # This simulates that behavior for testing the ingress proxy layer
    location /api/hassio_ingress/redacted/ {
        # Rewrite the path to remove the ingress prefix before proxying
        rewrite ^/api/hassio_ingress/redacted/(.*) /$1 break;
        
        proxy_pass http://localhost:5690;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        
        # Tell the app about the ingress prefix (Home Assistant standard)
        # The production nginx.conf will use this header to rewrite asset paths
        proxy_set_header X-Ingress-Path /api/hassio_ingress/redacted;

        # WebSocket support
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Origin $scheme://$host;
        proxy_cache off;
        proxy_buffering off;
    }
}
