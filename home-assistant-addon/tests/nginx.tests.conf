# Test nginx configuration for Home Assistant ingress simulation
# This file gets included by the base nginx.conf inside the http block
# Simulates how Home Assistant proxies addon traffic through ingress paths
#
# ARCHITECTURE:
# - Home Assistant ingress adds a path prefix like /api/hassio_ingress/{token}/
# - nginx strips this prefix before forwarding to Mastra (lines 22 below, also nginx.conf lines 47-48)
# - Mastra operates as if it's at the root path "/" (MASTRA_STUDIO_BASE_URL should NOT be set)
# - This allows the Studio UI to load correctly with all assets working
# - Both direct access (localhost:4111) and ingress access work correctly

server {
    server_name 0.0.0.0;
    listen 5000;

    # Home Assistant ingress path simulation
    # In production, Home Assistant creates paths like /api/hassio_ingress/{token}/
    # This simulates that behavior for testing the ingress proxy layer
    location /api/hassio_ingress/redacted/ {
        # Rewrite the path to remove the ingress prefix before proxying
        # This allows Mastra to operate as if it's at the root path "/"
        rewrite ^/api/hassio_ingress/redacted/(.*) /$1 break;
        
        proxy_pass http://127.0.0.1:4111;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        # WebSocket support
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Origin $scheme://$host;
        proxy_cache off;
        proxy_buffering off;

        # Proxy timeout settings to handle backend delays
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 300s;

        # Connection handling
        proxy_next_upstream error timeout http_502 http_503 http_504;
        proxy_next_upstream_tries 3;
        proxy_next_upstream_timeout 60s;
    }
}
