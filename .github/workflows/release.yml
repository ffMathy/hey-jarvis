name: Release

on:
  push:
    branches: [ main ]

env:
  HEY_JARVIS_ELEVENLABS_AGENT_ID: ${{ secrets.HEY_JARVIS_ELEVENLABS_AGENT_ID }}
  HEY_JARVIS_ELEVENLABS_API_KEY: ${{ secrets.HEY_JARVIS_ELEVENLABS_API_KEY }}
  HEY_JARVIS_ELEVENLABS_VOICE_ID: ${{ secrets.HEY_JARVIS_ELEVENLABS_VOICE_ID }}
  HEY_JARVIS_GOOGLE_GENERATIVE_AI_API_KEY: ${{ secrets.HEY_JARVIS_GOOGLE_GENERATIVE_AI_API_KEY }}
  HEY_JARVIS_OPENWEATHERMAP_API_KEY: ${{ secrets.HEY_JARVIS_OPENWEATHERMAP_API_KEY }}
  HEY_JARVIS_ELEVENLABS_TEST_AGENT_ID: ${{ secrets.HEY_JARVIS_ELEVENLABS_TEST_AGENT_ID }}
  HEY_JARVIS_CLOUDFLARED_TUNNEL_URL: ${{ secrets.HEY_JARVIS_CLOUDFLARED_TUNNEL_URL }}
  HEY_JARVIS_CLOUDFLARED_TUNNEL_TOKEN: ${{ secrets.HEY_JARVIS_CLOUDFLARED_TUNNEL_TOKEN }}
  
  GITHUB_ACTIONS: true

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.version }}
    steps:
      - name: Release using "Release Please"
        id: release
        uses: googleapis/release-please-action@v4
        with:
          config-file: .github/release-please-config.json
          manifest-file: .github/.release-please-manifest.json
          target-branch: main

  deploy:
    runs-on: ubuntu-latest
    if: ${{ needs.release.outputs.release_created }}
    needs: 
      - release
    permissions:
      contents: write
      packages: write

    steps:
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@v1.3.1
        with:
          # Only remove what we definitely don't need for faster cleanup
          android: false
          dotnet: true
          haskell: true
          large-packages: false  # Skip large packages check to save time
          docker-images: false   # Skip Docker image removal for devcontainer
          swap-storage: false    # Skip swap removal to save time

      - name: Checkout
        uses: actions/checkout@v6
        
      - name: Set lowercase repository owner
        run: echo "REPO_OWNER_LC=${GITHUB_REPOSITORY_OWNER,,}" >> $GITHUB_ENV

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Deploy in dev container
        uses: devcontainers/ci@v0.3
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
          REGISTRY: ghcr.io
          IMAGE_OWNER: ${{ env.REPO_OWNER_LC }}
        with:
          imageName: ghcr.io/${{ env.REPO_OWNER_LC }}/devcontainer
          cacheFrom: ghcr.io/${{ env.REPO_OWNER_LC }}/devcontainer
          push: always
          runCmd: nx run-many --target=deploy
          env: |
            GITHUB_TOKEN
            GITHUB_ACTOR
            GITHUB_ACTIONS
            REGISTRY
            IMAGE_OWNER
